# 隐私计算互联互通可信执行环境（TEE）统一远程证明API

- [隐私计算互联互通可信执行环境（TEE）统一远程证明API](#隐私计算互联互通可信执行环境（TEE）统一远程证明API)
  - [1 统一验证服务介绍](#1-统一验证服务介绍)
  - [2 统一验证服务流程](#2-统一验证服务流程)
    - [2.1 TEE 节点注册流程](#21-tee-节点注册流程)
    - [2.2 TEE 节点远程认证流程](#22-tee-节点远程认证流程)
    - [2.3 统一证明服务数据结构](#23-统一证明服务数据结构)
      - [UasAttestationResult](#uasattestationresult)
      - [UasReport](#uasreport)
      - [UasVerifyReq](#uasverifyreq)
      - [UasVerifyRes](#uasverifyres)
      - [UnifiedAttestationReport](#unifiedattestationreport)
    - [2.4 统一证明服务接口](#24-统一证明服务接口)


## 1 统一验证服务介绍

Unified Attestion Service（以下简称 UAS 或者统一验证服务）作为中心化远程证明统一代理验证服务，收敛所有异构 TEE 远程验证差异化逻辑，为其他验证方提供远程证明验证服务，使得验证方不再需要关心 TEE 平台差异。

统一证明服务本身也需要基于 TEE 实现，以此保证其自身验证逻辑的正确性。验证结果由统一证明服务进行背书确认，并且也封装为统一远程证明报告格式，方便验证方继续做其他额外校验。

## 2 统一验证服务流程

### 2.1 TEE 节点注册流程

统一证明服务的 TEE 节点注册流程是为了实现 TEE 节点向 UAS 注册，获取访问凭证。参考过程如下：

**参考流程一：**

- TEE 节点生成表征自己身份的一组公私钥对：ak.pub/ak.priv
- TEE 节点将自己必要的元信息与 ak.pub 发送给 UAS
- UAS 返回自己的根证书以及签发的 ak.crt 给 TEE 节点

**参考流程二：**

- TEE 节点提前获取用于验证 UAS 签名的公钥，内置于可信代码中。
- TEE 节点开发者或者挑战者都可以通过 UAS 管理界面注册元信息，获取访问凭证 AccessKey
- 后续 TEE 节点或者挑战者都可以通过 AccessKey+UAR 请求 UAS 提供的代理验证服务

### 2.2 TEE 节点远程认证流程

引入中心化的统一证明服务的 TEE 节点远程认证流程：

a)、护照模式报告转换为 UAS 格式报告

```
.-------.                 .--------------.                   .-----.
| 挑战者 |                 | TEE Attester |                   | UAS |
'---+---'                 '-------+------'                   '--+--'
    | 1) 生成随机的Nonce值          |                             |
    | 请求护照模式远程证明报告        |                             |
    +---------------------------->|                             |
    |                             | 2) TEE节点生成本地            |
    |                             | 护照模式报告                  |
    |                             |                             |
    |                             | 3) 发送统一验证服务验证请求     |
    |                             | (UAR、Nonce和访问凭证)        |
    |                             +---------------------------->|
    |                             |                             |
    |                             |               4) 验证访问凭证 |
    |                             |  根据TEE平台类型调用不同验证逻辑 |
    |                             |   (中间可能涉及对第三方服务请求) +-->
    |                             |  使用签名密钥对Nonce和校验结果  |
    |                             |     签名，并返回UAS统一证明报告 |
    |                             |<----------------------------+
    |                             |                             |
    |                             | TEE节点校验UAS签名(可选)       |
    |<----------------------------+ 5) TEE节点转发UAS格式UAR      |
    |                             |                             |
    | 6) 挑战者校验UAS签名信息       |                             |
    | 然后校验Nonce值               |                             |
    | 选择性校验其他报告内信息        |                             |
    | 完成认证流程                  |                             |
    |                             |                             |
```

b)、背调模式报告转换为 UAS 格式报告

```
.-------.                     .-------.                 .--------------.
|  UAS  |                     | 挑战者 |                 | TEE Attester |
'---+---'                     '---+---'                 '-------+------'
    |                             | 1) 生成随机的Nonce值          |
    |                             | 请求护照模式远程证明报告        |
    |                             +---------------------------->|
    |                             |                             |
    |                             |            2) TEE节点生成本地 |
    |                             |             背调模式报告并返回 |
    |                             |<----------------------------+
    |     3) 发送统一验证服务验证请求 |                             |
    |        (UAR、Nonce和访问凭证) |                             |
    |<----------------------------+                             |
    |                             |                             |
    | 4) 验证访问凭证               |                             |
    | 根据TEE平台类型调用不同验证逻辑  |                             |
 <--+ (中间可能涉及对第三方服务请求)   |                             |
    | 使用签名密钥对Nonce和校验结果   |                             |
    | 签名，并返回UAS统一证明报告     |                             |
    +---------------------------->|                             |
    |                             |                             |
    |                             | 6) 挑战者校验UAS签名信息       |
    |                             | 然后校验Nonce值               |
    |                             | 选择性校验其他报告内信息        |
    |                             | 完成认证流程                  |
    |                             |                             |
```

### 2.3 统一证明服务数据结构

#### UasAttestationResult

#### UasReport

#### UasVerifyReq

#### UasVerifyRes

#### UnifiedAttestationReport

### 2.4 统一证明服务接口

POST /v1/interconn/tee/uas/verify

**接口描述**

校验输入的不同平台和类型 TEE 远程证明报告，返回统一的 UAS 类型报告。

**请求参数**

UasVerifyReq

**返回结果**

UasVerifyRes

**状态码**

- 200: successful operation UasVerifyRes
- 400: Invalid input report UasVerifyRes
- 405: Verification failed UasVerifyRes
